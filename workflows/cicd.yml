name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    #- uses: actions/checkout@v2

    # Uncomment the below lines to run unit tests
    #- name: Run Unit Tests
    #  run: npm test 

    - name: Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: <skalbarasystemcontainerregistry.azurecr.io> # Replace with actual server name
        username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
        password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

    - name: Build and Push Docker Image
      run: |
        docker build -t skalbarasystemcontainerregistry.azurecr.io/myapp:${{ github.sha }} .
        docker push skalbarasystemcontainerregistry.azurecr.io/myapp:${{ github.sha }}

    - name: Build and Push Internal API Server Docker Image
      run: |
        cd src/models/mongo_api/server
        docker build -t skalbarasystemcontainerregistry.azurecr.io/internal_api_server:${{ github.sha }} .
        docker push skalbarasystemcontainerregistry.azurecr.io/internal_api_server:${{ github.sha }}

    # Uncomment the below lines to set up Azure credentials and deploy to AKS
    #- name: Set up Azure credentials
    #  uses: azure/login@v1
    #  with:
    #    creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    #- name: Deploy to Azure Kubernetes Service
    #  run: |
    #    kubectl set image deployment/myapp-deployment myapp=<your_acr_login_server>/myapp:${{ github.sha }}
    #    kubectl rollout status deployment/myapp-deployment
